# AirGuard

## マスタデータの取り込みについて

マスタデータのアプリケーション内での利用については

- store に全件読み込んでおく
- 利用する都度読み込む

の 2 通りが考えられる。

### store に全件読み込む場合

マスタデータの件数がそれほど膨大でなければ結果として読み込み回数を抑制できるメリットが大きいが、

- アプリ起動時に読み込み完了を待つ必要がある。
- 各コンポーネントの store への依存度が高くなる。

というデメリットが発生する。

### 利用する都度読み込む場合

マスタデータが膨大である場合に、アプリの動作を軽くできるメリットが大きいが、

- 各コンポーネントが必要とするマスタを読み込む処理が発生する。
- 一つの処理で同じマスタデータを読み込む無駄を省くなど、読み込む回数を抑制できるよう工夫が必要。

AirGuard は現場マスタ（Sites）が日に数件～十数件登録される可能性がある。
2024 年 1 月現在で 1,500 件登録されており、これをアプリの起動の都度、全件読み込むのは現実的ではない。
よって、「利用する都度読み込む」方法を採用する。

## 従属データが保有する親データ

取引先（Customers）と現場（Sites）のように従属関係があるデータについて、子（現場）が親（取引先）をどのように持つか。

- ID のみを保有し、必要なときに親データを読み込む。
- オブジェクトとして親データ全てを保有する。

の 2 通りの方法がある。

前者は、特に親データ表示のためにコンポーネント化した場合など、親データの重複読み込みの発生を余儀なくされることがあり、工夫をしないと読み込み件数が膨れ上がる可能性がある。

後者は親データを表示するための読み込みを行う必要がなくなる反面、ドキュメントのサイズが大きくなるほか、親の情報が更新された際に子が保有する親データを Cloud Functions で同期させる必要が出てくる。また、子を編集中に親が変更され、それを検知せずに子の編集を確定させた場合に子は古い親データを持ったまま更新されてしまう。

NoSQL の利点を活用できなくなるが、データの妥当性を保持するためにも「ID のみを保有し、必要な時に親データを読み込む」方法を採用する。

## Ngram 方式による全文検索

Firestore はあいまい検索ができない。AirGuard では登録されているデータの検索機能が重要で、特に現場名などをあいまい検索によって絞り込む必要がある。
よって、Ngram 方式によるあいまい検索を実装する。ただし、検索の対象とするフィールド（文字数）が多くなるとドキュメントのサイズが肥大することに注意する。
モデルごとにあいまい検索の対象フィールドを限定し、フィールド値を 1-2 文字ずつに分割した値をオブジェクト型フィールドである「tokenMap」のプロパティ名として使用する。
例：「株式会社」の場合、1 文字ずつに分割した値と、「株式」、「式会」、「会社」の 2 文字に分割した値をプロパティ名とする。
この方式を採用する場合、Firestore ドキュメントのフィールド名には UTF-8 で有効な文字列でなければならず、一部の特殊文字（例：𡈽）が使用できない。
よって、あいまい検索対象フィールドにはこれらの文字が使用されないようにしなければならない。

### 使用できない特殊文字の判定

使用できない特殊文字の判定は「サロゲートペア」を含むか、含まないかで判断する。
https://codezine.jp/article/detail/1592

### 改修・追加機能

- Cloud Functions の onUpdated トリガーが、内容に変更がなくても更新されてしまう。
  - 更新日時（updateAt、updateDate）が更新されるため。
  - 作成日時、更新日時はサブコレクションに history を作るべきか？
